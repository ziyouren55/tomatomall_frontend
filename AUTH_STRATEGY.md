# 登录权限控制策略说明

## 概述

本项目采用**前后端双重验证**的权限控制策略，既保证用户体验，又确保安全性。

## 权限控制机制

### 1. 前端路由守卫（主要拦截）

**位置：** `src/router/guards.ts`

**工作原理：**
- 在路由跳转前检查 `meta.requiresAuth` 标识
- 如果需要登录但用户未登录，保存当前路径并跳转到登录页
- 登录成功后自动返回之前访问的页面

**优点：**
- ✅ 用户体验好：在点击链接时就拦截，不需要等待API调用
- ✅ 减少无效请求：避免未登录用户发起API请求
- ✅ 快速响应：本地检查token，无需网络请求

**需要登录的页面：**
- `/product/:id` - 商品详情页
- `/cart` - 购物车
- `/order` - 订单页面
- `/profile` - 个人中心
- `/bookcomment` - 书评
- `/advertisement` - 广告
- `/coupon/:id` - 优惠券详情
- `/member` - 会员中心
- `/warehouse` - 仓库管理（管理员）

**不需要登录的页面：**
- `/` - 首页（可以浏览商品列表）
- `/login` - 登录页
- `/register` - 注册页

### 2. 后端API拦截（安全保障）

**位置：** 后端拦截器/过滤器

**工作原理：**
- 后端验证请求头中的 `token`
- 如果token无效或缺失，返回 `401 Unauthorized`
- 前端收到401后，清除本地token并跳转到登录页

**优点：**
- ✅ 安全性高：防止绕过前端直接调用API
- ✅ 数据安全：确保只有合法用户才能获取数据
- ✅ 防止伪造：后端验证token的有效性

**前端处理：** `src/api/config/request.ts`

```typescript
// 响应拦截器处理401错误
if (error.response.status === 401) {
    removeToken()
    // 保存当前路径
    sessionStorage.setItem('redirectPath', currentPath)
    // 跳转到登录页
    router.push('/login')
}
```

## 工作流程

### 场景1：未登录用户访问商品详情页

1. **前端路由守卫拦截**
   - 用户点击商品链接 → 路由守卫检查 `requiresAuth: true`
   - 发现未登录 → 保存当前路径 `/product/123` 到 `sessionStorage`
   - 跳转到 `/login`

2. **用户登录成功**
   - 登录成功后读取 `sessionStorage` 中的 `redirectPath`
   - 自动跳转回 `/product/123`

3. **如果用户绕过前端直接调用API**
   - 后端验证token → 返回401
   - 前端响应拦截器捕获401 → 清除token并跳转登录页

### 场景2：已登录用户访问需要登录的页面

1. **前端路由守卫检查**
   - 检查token存在 → 允许访问
   - 正常加载页面

2. **API请求**
   - 请求拦截器自动添加token到请求头
   - 后端验证token有效 → 返回数据

### 场景3：token过期

1. **API请求返回401**
   - 后端验证token已过期 → 返回401

2. **前端响应拦截器处理**
   - 清除本地token
   - 保存当前路径
   - 跳转到登录页

## 后端需要实现的拦截

后端应该在以下接口添加token验证：

1. **购物车相关**
   - `GET /api/cart` - 获取购物车
   - `POST /api/cart` - 添加到购物车
   - `PUT /api/cart/:id` - 更新购物车
   - `DELETE /api/cart/:id` - 删除购物车项

2. **订单相关**
   - `GET /api/orders` - 获取订单列表
   - `GET /api/orders/:id` - 获取订单详情
   - `POST /api/orders/:id/pay` - 支付订单

3. **用户相关**
   - `GET /api/user/:username` - 获取用户信息
   - `PUT /api/user` - 更新用户信息

4. **商品详情**（可选，根据业务需求）
   - `GET /api/products/:id` - 获取商品详情（如果需要登录才能查看）

## 总结

- **前端路由守卫**：提供良好的用户体验，快速拦截未授权访问
- **后端API拦截**：确保数据安全，防止绕过前端直接调用API
- **双重验证**：前后端配合，既保证用户体验，又确保安全性

## 注意事项

1. **首页不需要登录**：允许未登录用户浏览商品列表
2. **商品详情需要登录**：点击查看详情时要求登录
3. **购物车需要登录**：所有购物车操作都需要登录
4. **自动跳转**：登录成功后自动返回之前访问的页面
5. **token管理**：登录时保存token，注销时清除token

